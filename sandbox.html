<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>sandbox</title>
  <style>
  div.container {
    display: flex;   /* Magic begins */
    flex-direction: row;
    width: 100vw;
    height: 50vw;
  }
  div.sim {
    flex-grow: 1;
    width: 50%;
  }
  div.link {
    stroke: #bbb;
  }
  button  {
    float: left
  }
  .node circle {
    stroke-width: 2px;
    r: 2px
  }
  *
  {
    margin:0;
    padding:0;
  }
  div.text
  {
    flex-grow: 1;
    width: 50%;
    padding-left: 5%;
    padding-right: 1%;
    align-self: flex-end;
    text-align: right;
    font-family: Futura, "Trebuchet MS", Arial, sans-serif;
    font-weight: bold;
    color: black;
  }
  h1
  {
    margin: 3%;
    font-size: 32px;
  }
  h2
  {
    margin: 3%;
    font-size: 14px;
  }
  p
  {
    margin: 3%;
    font-size: 16px;
  }

  </style>
  <script src="https://d3js.org/d3.v5.js"></script>
  <script src="nbody.js"></script>
  <script src="initialize.js"></script>
  <script src="drawing.js"></script>
</head>
<body>
  <div  class="container">
    <div class="sim" id="sim"> </div>
    <div class="text">
      <h1> The sandbox </h1>
      <p> somewhere for me to play with new ideas </p>
    </div>
  </div>
  <div class="container">
    <div class='sim' id='sim'></div>
    <div class='text'>
      <h1> The sandbox </h1>
      <p> somewhere for me to play with new ideas </p>
    </div>
    <div class='controls' id='controls'></div>
  </div>
  <script type="text/javascript">

    var width=0.5*window.innerWidth || document.body.clientWidth;
    var height=width;
    var svg=d3.select("#sim").append("svg");
    svg.attr('width',width)
      .attr('height',height);


    var boxSize=30; // distance from edge to centre of visible box in kpc (for conversion to pixels)
    var ps=[];
    var lines=[];
    var satXs=[];
    var satYs=[];

    var nPassive=5000;
    var x0=[30,0,0]
    var v0=[0,180,0]
    hostOptions={m: 1e11, smooth:0.5}
    satOptions={m: 2e10, x: x0, v: v0, smooth: 0.2}
    haloOptions={shape: 'sphere',rMin: 2, smooth:0.1, active:0}
    ps=initializeParticle(ps,hostOptions)
    ps=initializeParticle(ps,satOptions)
    ps=initializeHalo(ps,nPassive,haloOptions)

    centreFrame(ps);

    satXs.push(ps[1].x[0])
    satYs.push(ps[1].x[1])

    var nParticles=ps.length;

    var circles=joinCircles();

    var dt=0.001
    var tTotal=0
    var nSteps=0

    acceleration(ps);
    var isFixed=0
    function evolve() {
      leapfrog(dt,fixed=isFixed);
      tTotal=tTotal+dt;
      nSteps=nSteps+1;
      for (var i=0; i < nParticles; i++){

        if ((i==1) && (nSteps%10==0)){
          var sat=ps[i];
          satXs.push(sat.x[0]);
          satYs.push(sat.x[1]);
          var newLine = new lineElement();
          newLine.x1=satXs[(nSteps/10)-1];
          newLine.x2=satXs[(nSteps/10)];
          newLine.y1=satYs[(nSteps/10)-1];
          newLine.y2=satYs[(nSteps/10)];
          lines.push(newLine);
          svg.selectAll("line").data(lines).join("line")
            .attr("x1", function(d) {return width*(d.x1+boxSize)/(2*boxSize);})
            .attr("y1", function(d) {return width*(d.y1+boxSize)/(2*boxSize);})
            .attr("x2", function(d) {return width*(d.x2+boxSize)/(2*boxSize);})
            .attr("y2", function(d) {return width*(d.y2+boxSize)/(2*boxSize);})
            .style("stroke", "#ccc");
        }

        if (i>1000) {continue;}
        var thisCircle=d3.select('#particle'+ps[i].id);
        thisCircle
          .attr('cx', function(d) {return width*(d.x[0]+boxSize)/(2*boxSize);})
          .attr('cy',function(d) {return width*(d.x[1]+boxSize)/(2*boxSize);})
          .style("fill", function(d,i) {
            if (d.id>1){
              var v=Math.sqrt(d.v[0]**2 + d.v[1]**2 + d.v[2]**2 );
              var energy = d.Phi + 0.5*d.m*(v**2)
              var virial = 0.5*d.m*(v**2) + d.Phi/2
              return d3.interpolateSpectral(virial/1e13)
            }
            return d.c
        })
      }

      t = d3.now();
      var fps = 1000 / (t - t0);
      info.html(fmt(fps) + " fps = " + fmt(fps) + ' frames/sec');
      t0=t;
    }

    var info = d3.select('body').append('div')
      .style('position', 'absolute')
      .style('top', '0')
      .style('left', '0')
      .style('padding', '5px')
      .style('background-color', '#aaa');
    var start = d3.now(), t0 = 0, sum = 0, cnt = 0;
    var fmt = d3.format(",d");

    var startStop=1
    document.body.onkeyup = function(e){
      if(e.keyCode == 32){
          startStop=(startStop+1)%2
          if (startStop==0) {timer.stop();}
          if (startStop==1) {timer.restart(evolve,1000/30);}
      }
    }
    var timer=d3.interval(evolve,1000/30);

    // Initialize the button
    var allGroup = ["yellow", "blue", "red", "green", "purple", "black"]
    var fixButton = d3.select("#sim")
      .append('button')
      .text("fix center")
      .on("click",function(){
        isFixed=(isFixed+1)% 2;
      });
    var restartButton = d3.select("#sim")
      .append('button')
      .text("restart")
      .on("click",function(){
        nSteps=0;
        ps=[];
        lines=[];
        satXs=[];
        satYs=[];

        ps=initializeParticle(ps,hostOptions)
        ps=initializeParticle(ps,satOptions)
        ps=initializeHalo(ps,nPassive,haloOptions)

        satXs.push(ps[1].x[0])
        satYs.push(ps[1].x[1])

        circles.remove();
        circles=joinCircles();
      });
    </script>
</body>
</html>
