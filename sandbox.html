<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>sandbox</title>
  <style>
  div.container {
    display: flex;   /* Magic begins */
    flex-direction: row;
    width: 100vw;
    height: 50vw;
  }
  div.sim {
    flex-grow: 1;
    width: 50%;
  }
  div.link {
    stroke: #bbb;
  }
  button  {
    float: left
  }
  .node circle {
    stroke-width: 2px;
    r: 2px
  }
  *
  {
    margin:0;
    padding:0;
  }
  div.text
  {
    flex-grow: 1;
    width: 50%;
    padding-left: 5%;
    padding-right: 1%;
    align-self: flex-end;
    text-align: right;
    font-family: Futura, "Trebuchet MS", Arial, sans-serif;
    font-weight: bold;
    color: black;
  }
  h1
  {
    margin: 3%;
    font-size: 32px;
  }
  h2
  {
    margin: 3%;
    font-size: 14px;
  }
  p
  {
    margin: 3%;
    font-size: 16px;
  }

  </style>
  <script src="https://d3js.org/d3.v5.js"></script>
  <script src="nbody.js"></script>
</head>
<body>
  <div  class="container">
    <div class="sim" id="sim"> </div>
    <div class="text">
      <h1> The sandbox </h1>
      <p> somewhere for me to play with new ideas </p>
    </div>
  </div>
  <script type="text/javascript">

    var width=0.5*window.innerWidth || document.body.clientWidth;
    var height=width;
    var svg=d3.select("#sim").append("svg");
    svg.attr('width',width)
      .attr('height',height);


    var boxSize=30;
    var ps;
    var lines;
    var satXs;
    var satYs;
    function initialize() {
      ps=[];
      lines=[];
      satXs=[];
      satYs=[];
      var host = new gravParticle();
      host.m=1e11;
      host.flag=1;
      host.c='black'
      host.smooth=1
      host.r=0.5*host.smooth*width/boxSize
      var sat = new gravParticle();
      sat.m=2e10;
      sat.id=1;
      sat.flag=1;
      sat.x=[30,0,0];
      sat.v=[0,0.9*Math.sqrt(Galt*2e11/30),0];
      sat.c='black'
      sat.smooth=0.5
      sat.r=0.5*sat.smooth*width/boxSize
      host.v[1]=-(sat.m/host.m)*sat.v[1]
      ps.push(host);
      ps.push(sat);
      satXs.push(sat.x[0]);
      satYs.push(sat.x[1]);
      rMin=1
      rMax=20
      nPassive=10;
      for (var i=0;i<nPassive;i++){
        var pNew = new gravParticle();
        pNew.m=1e11/nPassive;
        pNew.id=i+2;
        pNew.flag=1;
        var theta=0.5*Math.PI;
        //var theta=Math.PI*Math.random();
        var phi=2*Math.PI*Math.random();
        var r=rMin+Math.sqrt(Math.random()*(rMax**2 - rMin**2));
        //var r=rMin+Math.random()*(rMax - rMin);
        pNew.x=[r*Math.cos(phi)*Math.sin(theta),r*Math.sin(phi)*Math.sin(theta),r*Math.cos(theta)];
        var v=Math.sqrt(Galt*1e11/r);
        var vTheta=0.5*Math.PI
        //var vTheta=Math.PI*Math.random();
        //var vPhi=phi+Math.PI/2
        var vPhi=2*Math.PI*Math.random();
        pNew.v=[v*Math.sin(vTheta)*Math.cos(vPhi),v*Math.sin(vTheta)*Math.sin(vPhi),v*Math.cos(vTheta)]
        //pNew.v=[150*(-1+2*Math.random()),150*(-1+2*Math.random()),150*(-1+2*Math.random())];
        pNew.smooth=0.1
        pNew.r=0.2*width/(2*boxSize)
        ps.push(pNew);
      }
    }
    initialize();

    var nParticles=ps.length;

    var circles=svg.selectAll(".node")
      .data(ps)
      .join('circle')
      .attr('id',function(d) { return "particle" + d.id; })
      .attr('r',function(d,i) {
        if (i>1000) {return 0}
        return d.r; })
      .style("fill", function(d) {return d.c})
      .attr('cx', function(d) {return width*(d.x[0]+boxSize)/(2*boxSize);})
      .attr('cy', function(d) {return width*(d.x[1]+boxSize)/(2*boxSize);});

    var dt=0.001
    var tTotal=0
    var nSteps=0

    acceleration(ps);
    var isFixed=0
    function evolve() {
      leapfrog(dt,fixed=isFixed);
      tTotal=tTotal+dt;
      nSteps=nSteps+1;
      for (var i=0; i < nParticles; i++){

        if ((i==1) && (nSteps%10==0)){
          var sat=ps[i];
          satXs.push(sat.x[0]);
          satYs.push(sat.x[1]);
          var newLine = new lineElement();
          newLine.x1=satXs[(nSteps/10)-1];
          newLine.x2=satXs[(nSteps/10)];
          newLine.y1=satYs[(nSteps/10)-1];
          newLine.y2=satYs[(nSteps/10)];
          lines.push(newLine);
          svg.selectAll("line").data(lines).join("line")
            .attr("x1", function(d) {return width*(d.x1+boxSize)/(2*boxSize);})
            .attr("y1", function(d) {return width*(d.y1+boxSize)/(2*boxSize);})
            .attr("x2", function(d) {return width*(d.x2+boxSize)/(2*boxSize);})
            .attr("y2", function(d) {return width*(d.y2+boxSize)/(2*boxSize);})
            .style("stroke", "#ccc");
        }

        if (i>1000) {continue;}
        var thisCircle=d3.select('#particle'+ps[i].id);
        thisCircle
          .attr('cx', function(d) {
            console.log(d)
            console.log(d.x)
            return width*(d.x[0]+boxSize)/(2*boxSize);})
          .attr('cy',function(d) {return width*(d.x[1]+boxSize)/(2*boxSize);})
          .style("fill", function(d,i) {
            if (d.id>1){
              var v=Math.sqrt(d.v[0]**2 + d.v[1]**2 + d.v[2]**2 );
              var energy = d.Phi + 0.5*d.m*(v**2)
              var virial = 0.5*d.m*(v**2) + d.Phi/2
              return d3.interpolateSpectral(virial/1e13)
              //var v=Math.sqrt(d.v[0]**2 + d.v[1]**2 + d.v[2]**2 );
              //return d3.interpolateSpectral(v/300)
              //return d3.interpolateSpectral((d.x[2]+boxSize)/(2*boxSize))
            }
            return d.c
        })
      }

      t = d3.now();
      var fps = 1000 / (t - t0);
      info.html(fmt(fps) + " fps = " + fmt(fps) + ' frames/sec');
      t0=t;
    }

    var info = d3.select('body').append('div')
      .style('position', 'absolute')
      .style('top', '0')
      .style('left', '0')
      .style('padding', '5px')
      .style('background-color', '#aaa');
    var start = d3.now(), t0 = 0, sum = 0, cnt = 0;
    var fmt = d3.format(",d");

    var startStop=1
    document.body.onkeyup = function(e){
      if(e.keyCode == 32){
          startStop=(startStop+1)%2
          if (startStop==0) {timer.stop();}
          if (startStop==1) {timer.restart(evolve,1000/30);}
      }
    }
    var timer=d3.interval(evolve,1000/30);

    // Initialize the button
    var allGroup = ["yellow", "blue", "red", "green", "purple", "black"]
    var fixButton = d3.select("#sim")
      .append('button')
      .text("change data")
      .on("click",function(){
        isFixed=(isFixed+1)% 2;
      });
    var restartButton = d3.select("#sim")
      .append('button')
      .text("restart")
      .on("click",function(){
        nSteps=0;
        initialize();
      });
    //dropdownButton // Add a button
    //  .selectAll('myOptions') // Next 4 lines add 6 options = 6 colors
   	 // .data(allGroup)
      //.enter()
  	  //.append('option')
      //.text(function (d) { return d; }) // text showed in the menu
      //.attr("value", function (d) { return d; }) // corresponding value returned by the button
  </script>
</body>
</html>
